// 1. Configuración del Generador y la Fuente de Datos
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --------------------------------------------------------
// DOMINIO DE USUARIOS Y AUTENTICACIÓN (Auth & Access)
// --------------------------------------------------------

enum UserRole {
  ADMIN
  TEACHER
  STUDENT
  PARENT
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String // Hash bcrypt/argon2
  firstName String
  lastName  String
  role      UserRole
  isActive  Boolean  @default(true) // Soft delete
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones Polimórficas (Un usuario puede tener uno de estos perfiles)
  teacherProfile Teacher?
  studentProfile Student?
  parentProfile  Parent?

  // Auditoría (Quién hizo qué)
  auditLogs AuditLog[]

  @@map("users")
}

// --------------------------------------------------------
// DOMINIO ACADÉMICO (Curriculum & Estructura)
// --------------------------------------------------------

model AcademicYear {
  id        String   @id @default(uuid())
  name      String // Ej: "2024", "2025"
  startDate DateTime
  endDate   DateTime
  isCurrent Boolean  @default(false) // Solo uno puede ser true

  terms             AcademicTerm[] // Bimestres, Trimestres
  courses           Course[] // Cursos dictados este año
  PaymentDefinition PaymentDefinition[]

  @@map("academic_years")
}

model AcademicTerm {
  id             String       @id @default(uuid())
  name           String // Ej: "I Bimestre"
  academicYearId String
  academicYear   AcademicYear @relation(fields: [academicYearId], references: [id])
  startDate      DateTime
  endDate        DateTime
  isClosed       Boolean      @default(false) // Si true, ya no se pueden editar notas

  assessments Assessment[]

  @@map("academic_terms")
}

model Grade {
  id    String @id @default(uuid())
  name  String // Ej: "1ro Secundaria", "5to Primaria"
  level String // Ej: "PRIMARIA", "SECUNDARIA" (Podría ser Enum)

  sections Section[]

  @@map("grades")
}

model Section {
  id      String @id @default(uuid())
  name    String // Ej: "A", "B", "Blue Group"
  gradeId String
  grade   Grade  @relation(fields: [gradeId], references: [id])

  students Student[] // Alumnos en esta sección (Snapshots anuales se manejarían en Enrollment)
  courses  Course[]

  @@unique([gradeId, name]) // No puede haber dos "1ro A"
  @@map("sections")
}

model Subject {
  id          String  @id @default(uuid())
  name        String // Ej: "Matemáticas", "Historia"
  code        String? @unique // Ej: "MAT-001"
  description String?

  courses Course[] // Instancias de esta materia en diferentes secciones/años

  @@map("subjects")
}

// --------------------------------------------------------
// DOMINIO DE OPERACIONES (Clases, Profesores, Alumnos)
// --------------------------------------------------------

model Teacher {
  id             String  @id @default(uuid())
  userId         String  @unique
  user           User    @relation(fields: [userId], references: [id])
  specialization String?

  coursesTaught Course[] // Cursos que dicta

  @@map("teachers")
}

model Parent {
  id     String  @id @default(uuid())
  userId String  @unique
  user   User    @relation(fields: [userId], references: [id])
  phone  String?

  children Student[] // Relación muchos a muchos implícita o explícita

  @@map("parents")
}

model Student {
  id             String   @id @default(uuid())
  userId         String   @unique
  user           User     @relation(fields: [userId], references: [id])
  enrollmentDate DateTime @default(now())

  // Relación actual (simplificada para MVP)
  sectionId String?
  section   Section? @relation(fields: [sectionId], references: [id])

  parents Parent[]

  attendance AttendanceRecord[]
  grades     GradeEntry[]
  Payment    Payment[]

  @@map("students")
}

// La "Instancia" de una materia. 
// Ej: "Matemáticas para 1ro A en 2024 dictado por el Profe Juan"
model Course {
  id        String  @id @default(uuid())
  subjectId String
  subject   Subject @relation(fields: [subjectId], references: [id])

  sectionId String
  section   Section @relation(fields: [sectionId], references: [id])

  teacherId String
  teacher   Teacher @relation(fields: [teacherId], references: [id])

  academicYearId String
  academicYear   AcademicYear @relation(fields: [academicYearId], references: [id])

  assessments Assessment[]
  attendance  AttendanceSession[]

  @@map("courses")
}

// --------------------------------------------------------
// DOMINIO DE EVALUACIÓN (Notas)
// --------------------------------------------------------

model Assessment {
  id     String @id @default(uuid())
  title  String // Ej: "Examen Parcial", "Tarea 1"
  weight Float // Peso en porcentaje (ej: 0.2 para 20%)

  courseId String
  course   Course @relation(fields: [courseId], references: [id])

  termId String
  term   AcademicTerm @relation(fields: [termId], references: [id])

  gradeEntries GradeEntry[] // Las notas de los alumnos para esta evaluación

  createdAt DateTime @default(now())

  @@map("assessments")
}

model GradeEntry {
  id       String  @id @default(uuid())
  value    Float // La nota (ej: 18.5)
  feedback String? // Comentario del profesor

  studentId String
  student   Student @relation(fields: [studentId], references: [id])

  assessmentId String
  assessment   Assessment @relation(fields: [assessmentId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([studentId, assessmentId]) // Un alumno solo tiene una nota por evaluación
  @@map("grade_entries")
}

// --------------------------------------------------------
// DOMINIO DE ASISTENCIA
// --------------------------------------------------------

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
  EXCUSED
}

model AttendanceSession {
  id       String   @id @default(uuid())
  date     DateTime @db.Date // Solo fecha, sin hora
  courseId String
  course   Course   @relation(fields: [courseId], references: [id])

  records AttendanceRecord[]

  @@unique([date, courseId]) // Solo se toma lista una vez por día por curso
  @@map("attendance_sessions")
}

model AttendanceRecord {
  id        String            @id @default(uuid())
  sessionId String
  session   AttendanceSession @relation(fields: [sessionId], references: [id])

  studentId String
  student   Student @relation(fields: [studentId], references: [id])

  status  AttendanceStatus
  remarks String? // Ej: "Llegó 15 min tarde"

  @@map("attendance_records")
}

// --------------------------------------------------------
// UTILITARIOS
// --------------------------------------------------------

model AuditLog {
  id        String   @id @default(uuid())
  action    String // "UPDATE_GRADE", "DELETE_USER"
  details   Json?
  userId    String?
  user      User?    @relation(fields: [userId], references: [id])
  createdAt DateTime @default(now())

  @@map("audit_logs")
}

// --------------------------------------------------------
// DOMINIO FINANCIERO (Tesorería)
// --------------------------------------------------------

enum PaymentStatus {
  PENDING
  PAID
  OVERDUE // Vencido
  CANCELLED
}

enum PaymentMethod {
  CASH
  TRANSFER
  CARD
}

// El "Catálogo" de cobros. Ej: "Pensión Marzo 2025 - Secundaria"
model PaymentDefinition {
  id          String   @id @default(uuid())
  title       String // Ej: "Pensión Marzo"
  description String?
  amount      Float // Ej: 500.00
  dueDate     DateTime // Fecha de vencimiento general

  academicYearId String
  academicYear   AcademicYear @relation(fields: [academicYearId], references: [id])

  // Relación: Un concepto genera muchos pagos individuales
  payments Payment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("payment_definitions")
}

// La deuda/pago individual de un alumno
model Payment {
  id String @id @default(uuid())

  studentId String
  student   Student @relation(fields: [studentId], references: [id])

  definitionId String
  definition   PaymentDefinition @relation(fields: [definitionId], references: [id])

  status PaymentStatus @default(PENDING)

  // Datos de cuando se paga
  paidAt          DateTime? // Fecha real del pago
  method          PaymentMethod?
  operationNumber String? // Nro de operación bancaria o recibo

  amountPaid Float? // Cuánto pagó realmente (por si hay mora o descuento)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([studentId, definitionId]) // Un alumno no debe tener duplicado el cobro de "Marzo"
  @@map("payments")
}
